package testutils

import (
	"bytes"
	"regexp"

	"go.uber.org/zap"
	"go.uber.org/zap/zapcore"
)

// RemoveJsonTimestamp removes the "time" field from a JSON log line generated by zap.
func RemoveJsonTimestamp(logOutput string) string {
	// Remove "time" field from output
	re := regexp.MustCompile(`\"timestamp\":\"[^\"]*\",`)
	return string(re.ReplaceAllString(logOutput, `"timestamp":"[TIMESTAMP]",`))
}

func defaultEncoderConfig() zapcore.EncoderConfig {
	return zapcore.EncoderConfig{
		MessageKey:       "msg",
		LevelKey:         "level",
		TimeKey:          "timestamp",
		FunctionKey:      "function",
		EncodeLevel:      zapcore.CapitalLevelEncoder,
		EncodeTime:       zapcore.ISO8601TimeEncoder,
		EncodeName:       zapcore.FullNameEncoder,
		ConsoleSeparator: " ",
	}
}

func DlogJsonLogger() (*zap.SugaredLogger, *bytes.Buffer) {
	buffer := &bytes.Buffer{}
	return zap.New(
		zapcore.NewCore(
			zapcore.NewJSONEncoder(defaultEncoderConfig()),
			zapcore.AddSync(buffer),
			zapcore.DebugLevel,
		),
	).Sugar(), buffer
}

func DlogTextLogger() (*zap.SugaredLogger, *bytes.Buffer) {
	buffer := &bytes.Buffer{}
	return zap.New(
		zapcore.NewCore(
			zapcore.NewConsoleEncoder(defaultEncoderConfig()),
			zapcore.AddSync(buffer),
			zapcore.DebugLevel,
		),
	).Sugar(), buffer
}
