name: Bytecode Diff Report
env:
    BASE_RPC_URL: ${{ secrets.BASE_RPC_URL }}
    BASE_SEPOLIA_RPC_URL: ${{ secrets.BASE_SEPOLIA_RPC_URL }}
    FACET_SOURCE_PATH: ../../contracts/src
    REPORT_OUT_DIR: ${{ vars.REPORT_OUT_DIR }}
    BASESCAN_API_KEY: ${{ secrets.BASESCAN_API_KEY }}
    BASESCAN_SEPOLIA_API_KEY: ${{ secrets.BASESCAN_SEPOLIA_API_KEY }}
    BASESCAN_SEPOLIA_URL: 'https://api-sepolia.basescan.org/api'
    BLOCKSCOUT_SEPOLIA_URL: 'https://base-sepolia.blockscout.com/api'
    BLOCKSCOUT_SEPOLIA_API_KEY: ${{ secrets.BLOCKSCOUT_BASE_SEPOLIA_API_KEY }}
    GOWORK: off
on:
    workflow_dispatch:
        inputs:
            origin_environment:
                description: 'Origin environment'
                required: true
                type: choice
                options:
                    - 'alpha'
                    - 'gamma'
                    - 'omega'
                default: 'alpha'
            target_environment:
                description: 'Target environment'
                required: true
                type: choice
                options:
                    - 'alpha'
                    - 'gamma'
                    - 'omega'
                default: 'gamma'
          
    workflow_call:
        inputs:
            origin_environment:
                description: 'Origin environment'
                required: true
                type: string
            target_environment:
                description: 'Target environment'
                required: true
                type: string

jobs:
    run:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: main
            
            - name: Run report generation
              run: |
                  go run main.go -v ${{ inputs.origin_environment }} ${{ inputs.target_environment }}
              working-directory: scripts/bytecode-diff

            - name: Get latest facet diff file
              run: |
                  FACET_DIFF_FILE=$(find ${{ env.REPORT_OUT_DIR }} -name "facet_diff*.yaml" | sort -r | head -n 1)
                  echo "Latest facet diff file: $FACET_DIFF_FILE"
                  echo "FACET_DIFF_FILE=$FACET_DIFF_FILE" >> $GITHUB_ENV
              working-directory: scripts/bytecode-diff

            - name: Run facet upgrades based on diffs
              run: |
                  ./scripts/upgrade-facets.sh ${{ inputs.target_environment }} ${{ env.REPORT_OUT_DIR }} ${{ env.FACET_DIFF_FILE }}
              working-directory: scripts/bytecode-diff