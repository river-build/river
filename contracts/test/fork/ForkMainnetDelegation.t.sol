// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

// utils
import {TestUtils} from "contracts/test/utils/TestUtils.sol";

//interfaces
import {IERC173} from "@river-build/diamond/src/facets/ownable/IERC173.sol";
import {INodeOperator} from "contracts/src/base/registry/facets/operator/INodeOperator.sol";
import {IMainnetDelegationBase} from "contracts/src/tokens/river/base/delegation/IMainnetDelegation.sol";

//libraries
import {NodeOperatorStatus} from "contracts/src/base/registry/facets/operator/NodeOperatorStorage.sol";

//contracts
import {MockMessenger} from "contracts/test/mocks/MockMessenger.sol";
import {MainnetDelegation} from "contracts/src/tokens/river/base/delegation/MainnetDelegation.sol";

// Base
contract ForkMainnetDelegationTest is TestUtils, IMainnetDelegationBase {
  address baseRegistry = 0x7c0422b31401C936172C897802CF0373B35B7698;

  MainnetDelegation internal mainnetDelegation;

  function setUp() external onlyForked {
    mainnetDelegation = MainnetDelegation(baseRegistry);
  }

  function test_removeDelegators() external onlyForked {
    address getMessenger = mainnetDelegation.getMessenger();
    address getProxyDelegation = mainnetDelegation.getProxyDelegation();

    MockMessenger mockMessenger = new MockMessenger();
    vm.etch(getMessenger, address(mockMessenger).code);
    MockMessenger(getMessenger).setXDomainMessageSender(getProxyDelegation);

    address delegatorAddress = 0x204f1aA5B666d0eAc07228D3065a461e92AC399c;

    Delegation memory delegator = mainnetDelegation.getDelegationByDelegator(
      delegatorAddress
    );

    assertEq(delegator.delegator, delegatorAddress);

    vm.prank(address(getMessenger));
    (bool success, ) = baseRegistry.call{gas: 200_000}(
      // solhint-disable-next-line max-line-length
      hex"012ad9da00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000204f1aa5b666d0eac07228d3065a461e92ac399c0000000000000000000000003541f646d321cacbc0ff4a7cccb583e8b6e413da"
    );

    assertTrue(success);

    delegator = mainnetDelegation.getDelegationByDelegator(delegatorAddress);

    assertEq(delegator.operator, address(0));
    assertEq(delegator.quantity, 0);
    assertEq(delegator.delegationTime, 0);
    assertEq(delegator.delegator, address(0));
  }

  // block number 23849000
  address[4] internal standbyOperators = [
    0x5093702683eDe45b52E1D5388306B77b1D27DFD0,
    0xa4742402D6E314a069CeB1c3C2C4eFb2982d7D33,
    0xA2f50A7Ed89666a805c4d96B35eaE43cB54Bc396,
    0x6C170403278651190494381181FC4358bB9b7B57
  ];

  function test_setBatchAuthorizedClaimers() external onlyForked {
    address getMessenger = mainnetDelegation.getMessenger();
    address getProxyDelegation = mainnetDelegation.getProxyDelegation();

    address owner = IERC173(baseRegistry).owner();
    vm.startPrank(owner);
    for (uint256 i; i < standbyOperators.length; ++i) {
      INodeOperator(baseRegistry).setOperatorStatus(
        standbyOperators[i],
        NodeOperatorStatus.Approved
      );
      INodeOperator(baseRegistry).setOperatorStatus(
        standbyOperators[i],
        NodeOperatorStatus.Active
      );
    }
    vm.stopPrank();

    MockMessenger mockMessenger = new MockMessenger();
    vm.etch(getMessenger, address(mockMessenger).code);
    MockMessenger(getMessenger).setXDomainMessageSender(getProxyDelegation);

    vm.prank(address(getMessenger));
    (bool success, ) = baseRegistry.call{gas: 20_000_000}(
      // solhint-disable-next-line max-line-length
      hex"f59832ed000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000007c00000000000000000000000000000000000000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000001640000000000000000000000000000000000000000000000000000000000000003900000000000000000000000097511657558e83b984ae32db30a27769dd155f20000000000000000000000000eb59ff9ff1384ec05f3dfbee403d6640635d19bb000000000000000000000000a8a2b42d64790482162147b0e47d57c11f41976e000000000000000000000000ec0452cae6c43c7af2ed165a44f18f1ad75388b80000000000000000000000006dd3cbc4bef3687c321636da2ff0874441031592000000000000000000000000a2da06c2f57527e559cddaa72f70763c068830d600000000000000000000000022b539777d9ca69397253950bdbff169e8194a02000000000000000000000000d5626dfeb1c92b95e7ba0ee1ecdf84184f5fa1e4000000000000000000000000214014ecff310f1ea7b2022820ac2857a765ffc800000000000000000000000090ef8ff07e7b8af29333a1d7c18bed949e197e060000000000000000000000003e5d4e5d2d8b44ee7f31346d8563139f5a1ebd91000000000000000000000000c675651841fcef07bc3285f716e11e14a4768aa100000000000000000000000058028aeafc61c069679c54b93b9a67a80f3848550000000000000000000000001fd51331a4e25e61fe15da65e7593ffb7860452c000000000000000000000000ce76bf32b0c50be0778f3064633ad84049222a880000000000000000000000006b56acfe20a06581ebef63a2fe35aa7e07645cf700000000000000000000000098dee8f33aba4de5dfce17816aa954a8a69eb0a2000000000000000000000000688a0549054bff40f94ec948d796581efdaab242000000000000000000000000ee7d8817b738beadfa27c0b7d1126e66ff6102d1000000000000000000000000df59b2f07918467a6a33d2306f9a7330dc2ad8e2000000000000000000000000fce4f00703351a3cc5cde9b450484f35bd5dfc350000000000000000000000006ef83a61c8d055eef7a553700c09b69b42aba1a30000000000000000000000002a290ba65c577124f5e7c0371d2daf664adc188f0000000000000000000000003923eed2daddb345e5bb43df360abb43ca2a155a00000000000000000000000090cbc76ced620bc56620f6f8b566ad2d7b6a72d20000000000000000000000002ce1f797ce5f4cac64709418ec6f3267864d97f300000000000000000000000075736178c0625d9d6646db0947e119f01279e8a100000000000000000000000099cb290c46c867e1555e312119b89f9e464a7fac000000000000000000000000e1f7ee77cb2a32961c3b953d4c7057ad22012132000000000000000000000000b0df35ba079ac48189a5e430bdff4dc302a38bfb00000000000000000000000068a7f574324e542ffbe18067f310991e8725de3e000000000000000000000000f9d27d4d6d397d800eb8b03066d0edf3cf8cbbb5000000000000000000000000139fbb4c024ec2023704c9bb7a755cc5d2c7440f000000000000000000000000896b7dd9b5be5f87ba526b37cd363343f9c8bc54000000000000000000000000acd7f327227f13bb90acfd99866b5af52059238a000000000000000000000000990102be05ad14d7bef9a616db9e529644f290fc0000000000000000000000008ebeadd9a70f44fecf90c567ddf4dc826a0e43e4000000000000000000000000df9eb5698d2927db0c221e57c67c6d65a33eda170000000000000000000000003f96d0314f1c865df2284116c243da6338f3349b0000000000000000000000009bd98be7ea3d711481b6001f71fda72e5be4727d0000000000000000000000004ed7c673158cf5872629336fd49107057706ba73000000000000000000000000af0083342f6df4a78e7b7c77916f19d51b66862a0000000000000000000000006af02db0c90db8f853cd649a34a894e65f5705b3000000000000000000000000b0f01287c8e84b43f9f9e3176e4505536e95eace0000000000000000000000006f3c412aae3f94c1dad1d73f039c2ec09082bf9b0000000000000000000000009bf1798ac65980bd889fb32cb535be6efb91ea96000000000000000000000000bb85b109f2e2b78ab0749d8c521d51646e8bd086000000000000000000000000f80bd83c6490af4c88e7b6473bceed3cf47a47cd000000000000000000000000fa3b7255758e863a6f0d4331225461d53d5d4dbf00000000000000000000000010ad9a3e4bcb34858f5cdb28d0ed7740c3a657f60000000000000000000000000113de6506ef86717b0d960b4c053db2cb36cc8c0000000000000000000000002ab66c157814dae9d9bc0ad53c7aa396ac0f63c70000000000000000000000002b9d74ffa4c9673e05b73e56a13b62698af57f1600000000000000000000000077963f69ff71798677f17b3c1d0eff4dffb202be000000000000000000000000c08f66b5ad46040047a255a69e8ad0d160fba1080000000000000000000000004cd5407fb9dc3627a12b0238fddd6751b8c74ad2000000000000000000000000ca0f1272e917d5d4aa41af0af3ab0c18ae0d2662000000000000000000000000000000000000000000000000000000000000003900000000000000000000000097511657558e83b984ae32db30a27769dd155f20000000000000000000000000eb59ff9ff1384ec05f3dfbee403d6640635d19bb0000000000000000000000005093702683ede45b52e1d5388306b77b1d27dfd00000000000000000000000005093702683ede45b52e1d5388306b77b1d27dfd0000000000000000000000000a4742402d6e314a069ceb1c3c2c4efb2982d7d33000000000000000000000000a4742402d6e314a069ceb1c3c2c4efb2982d7d33000000000000000000000000a4742402d6e314a069ceb1c3c2c4efb2982d7d33000000000000000000000000a4742402d6e314a069ceb1c3c2c4efb2982d7d33000000000000000000000000a4742402d6e314a069ceb1c3c2c4efb2982d7d33000000000000000000000000a4742402d6e314a069ceb1c3c2c4efb2982d7d33000000000000000000000000a4742402d6e314a069ceb1c3c2c4efb2982d7d33000000000000000000000000a4742402d6e314a069ceb1c3c2c4efb2982d7d33000000000000000000000000a4742402d6e314a069ceb1c3c2c4efb2982d7d33000000000000000000000000a2f50a7ed89666a805c4d96b35eae43cb54bc396000000000000000000000000a2f50a7ed89666a805c4d96b35eae43cb54bc396000000000000000000000000a2f50a7ed89666a805c4d96b35eae43cb54bc396000000000000000000000000a4742402d6e314a069ceb1c3c2c4efb2982d7d33000000000000000000000000a4742402d6e314a069ceb1c3c2c4efb2982d7d33000000000000000000000000a4742402d6e314a069ceb1c3c2c4efb2982d7d33000000000000000000000000a2f50a7ed89666a805c4d96b35eae43cb54bc396000000000000000000000000a2f50a7ed89666a805c4d96b35eae43cb54bc396000000000000000000000000a2f50a7ed89666a805c4d96b35eae43cb54bc396000000000000000000000000a2f50a7ed89666a805c4d96b35eae43cb54bc396000000000000000000000000a2f50a7ed89666a805c4d96b35eae43cb54bc39600000000000000000000000009285f179a9ba06ceba12decd1755ac6942a8cf400000000000000000000000009285f179a9ba06ceba12decd1755ac6942a8cf400000000000000000000000075736178c0625d9d6646db0947e119f01279e8a100000000000000000000000099cb290c46c867e1555e312119b89f9e464a7fac000000000000000000000000a2f50a7ed89666a805c4d96b35eae43cb54bc396000000000000000000000000a4742402d6e314a069ceb1c3c2c4efb2982d7d33000000000000000000000000a2f50a7ed89666a805c4d96b35eae43cb54bc396000000000000000000000000a2f50a7ed89666a805c4d96b35eae43cb54bc396000000000000000000000000a2f50a7ed89666a805c4d96b35eae43cb54bc39600000000000000000000000009285f179a9ba06ceba12decd1755ac6942a8cf400000000000000000000000009285f179a9ba06ceba12decd1755ac6942a8cf400000000000000000000000009285f179a9ba06ceba12decd1755ac6942a8cf4000000000000000000000000bb6ade9f54743e1e5f5a05373d6cf26513d3f424000000000000000000000000bb6ade9f54743e1e5f5a05373d6cf26513d3f424000000000000000000000000bb6ade9f54743e1e5f5a05373d6cf26513d3f424000000000000000000000000bb6ade9f54743e1e5f5a05373d6cf26513d3f424000000000000000000000000245c79838294922ea5dbb86778cf262cfc2e2ab0000000000000000000000000245c79838294922ea5dbb86778cf262cfc2e2ab0000000000000000000000000245c79838294922ea5dbb86778cf262cfc2e2ab0000000000000000000000000245c79838294922ea5dbb86778cf262cfc2e2ab0000000000000000000000000f9e7aafc114990b42b5d9a5fb002465c9ea41c8c000000000000000000000000f9e7aafc114990b42b5d9a5fb002465c9ea41c8c000000000000000000000000f9e7aafc114990b42b5d9a5fb002465c9ea41c8c000000000000000000000000f9e7aafc114990b42b5d9a5fb002465c9ea41c8c000000000000000000000000f9e7aafc114990b42b5d9a5fb002465c9ea41c8c000000000000000000000000de42f8fa9b9f856a8d0c3e92e25905bd8bc44545000000000000000000000000de42f8fa9b9f856a8d0c3e92e25905bd8bc44545000000000000000000000000de42f8fa9b9f856a8d0c3e92e25905bd8bc44545000000000000000000000000de42f8fa9b9f856a8d0c3e92e25905bd8bc445450000000000000000000000006c170403278651190494381181fc4358bb9b7b570000000000000000000000006c170403278651190494381181fc4358bb9b7b570000000000000000000000006c170403278651190494381181fc4358bb9b7b570000000000000000000000006c170403278651190494381181fc4358bb9b7b5700000000000000000000000000000000000000000000000000000000000000390000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a28c8d49957f757dc9eb3df461f0c416f97a2b000000000000000000000000006314664483fb84462b91e8fafc59942fc53e729e000000000000000000000000f0d0bd97ee80a97cb2fd2a9e070e0b93913e8c7500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000da712479c7a8437267d599b48bb2beb59e8e7e19000000000000000000000000f18a08f66881b419c60149eb040615aea00c089f00000000000000000000000075736178c0625d9d6646db0947e119f01279e8a100000000000000000000000099cb290c46c867e1555e312119b89f9e464a7fac000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000007dd6d501ca498070f6a0a4868f9c1fb631b2e27b0000000000000000000000000000000000000000000000000000000000000039000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001bc16d674ec800000000000000000000000000000000000000000000000000001bc16d674ec8000000000000000000000000000000000000000000000010f50b47f01fbb0be4000000000000000000000000000000000000000000000014839abf82f75273640000000000000000000000000000000000000000000000146a3196da3945bfc80000000000000000000000000000000000000000000000148e3140e6e7f7eea4000000000000000000000000000000000000000000000014c321c7da9b3356e400000000000000000000000000000000000000000000001450c852700dd1bd640000000000000000000000000000000000000000000000157502537d83297b48000000000000000000000000000000000000000000000014c321c7da9b3356e40000000000000000000000000000000000000000000000146e997c1b065c2920000000000000000000000000000000000000000000000014a35e43aec942e5240000000000000000000000000000000000000000000000147f5e8bc163dd0ee40000000000000000000000000000000000000000000000148e3140e6e7f7eea4000000000000000000000000000000000000000000000014ae6130a615741da4000000000000000000000000000000000000000000000014a35e43aec942e524000000000000000000000000000000000000000000000015662f9077485af42400000000000000000000000000000000000000000000001463d73b57256201a40000000000000000000000000000000000000000000000149d03f60c6c12ce6400000000000000000000000000000000000000000000001498c7c24ad89d69e40000000000000000000000000000000000000000000000144eaa388f44170b24000000000000000000000000000000000000000000000014ed7bcd6a5dc943e4000000000000000000000000000000000000000000000000b4d5ce7449070c0800000000000000000000000000000000000000000000002d9d96f3cdca3fb4c8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000147f5e7de0ad29678000000000000000000000000000000000000000000000001472a9f07ca97ce1640000000000000000000000000000000000000000000000145940b9f334bc8664000000000000000000000000000000000000000000000014839abf82f75273640000000000000000000000000000000000000000000000147904303e4ff950c00000000000000000000000000000000000000000000000295be96e64066972000000000000000000000000000000000000000000000000295be96e640669720000000000000000000000000000000000000000000000000dc94dd416e9b45dcc0000000000000000000000000000000000000000000000295be96e64066972000000000000000000000000000000000000000000000000295be96e64066972000000000000000000000000000000000000000000000000295be96e640669720000000000000000000000000000000000000000000000001e312cf6fc37e174800000000000000000000000000000000000000000000000295be96e640669720000000000000000000000000000000000000000000000001f04ef12cb04cf15800000000000000000000000000000000000000000000000295be96e640669720000000000000000000000000000000000000000000000001e312cf6fc37e1748000000000000000000000000000000000000000000000002888275295397bd10000000000000000000000000000000000000000000000002888275295397bd10000000000000000000000000000000000000000000000002888275295397bd100000000000000000000000000000000000000000000000014adf4b7320334b900000000000000000000000000000000000000000000000001bca47d1dc43b8fb400000000000000000000000000000000000000000000002888275295397bd1000000000000000000000000000000000000000000000000295be96e64066972000000000000000000000000000000000000000000000000295be96e640669720000000000000000000000000000000000000000000000001e312cf6fc37e1748000000000000000000000000000000000000000000000001e312cf6fc37e1748000000000000000000000000000000000000000000000001e312cf6fc37e174800000000000000000000000000000000000000000000000295be96e64066972000000000000000000000000000000000000000000000000295be96e64066972000000"
    );

    // Check the result
    require(success, "Call failed");
  }
}
